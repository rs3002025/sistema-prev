import re
from app import app, db
from app import CorrectionFactor

def parse_factors(text_block):
    """Parses the multiline string of factors into a list of tuples."""
    factors = []
    lines = text_block.strip().split('\n')
    # Regex to find lines that look like 'mon/yy <float>'
    pattern = re.compile(r"^(?P<month_year>\w{3}/\d{2})\s+(?P<value>[\d,\.]+)$")
    for line in lines:
        match = pattern.match(line.strip())
        if match:
            data = match.groupdict()
            # Convert comma decimal separator to dot
            value_str = data['value'].replace(',', '.')
            factors.append((data['month_year'], float(value_str)))
    return factors

# The raw data provided by the user
factors_data_string = """
jul/94	11,477866
ago/94	10,820009
set/94	10,259818
out/94	10,107206
nov/94	9,922643
dez/94	9,608446
jan/95	9,402530
fev/95	9,248082
mar/95	9,157427
abr/95	9,030100
mai/95	8,859989
jun/95	8,637993
jul/95	8,483596
ago/95	8,279904
set/95	8,196307
out/95	8,101516
nov/95	7,989659
dez/95	7,870811
jan/96	7,743051
fev/96	7,631635
mar/96	7,577825
abr/96	7,555915
mai/96	7,503394
jun/96	7,379416
jul/96	7,290477
ago/96	7,211865
set/96	7,211570
out/96	7,202212
nov/96	7,186402
dez/96	7,166335
jan/97	7,103820
fev/97	6,993328
mar/97	6,964075
abr/97	6,884223
mai/97	6,843842
jun/97	6,823376
jul/97	6,775944
ago/97	6,769854
set/97	6,769854
out/97	6,730138
nov/97	6,707335
dez/97	6,652123
jan/98	6,606536
fev/98	6,548911
mar/98	6,547599
abr/98	6,532576
mai/98	6,532576
jun/98	6,517583
jul/98	6,499382
ago/98	6,499382
set/98	6,499382
out/98	6,499382
nov/98	6,499382
dez/98	6,499382
jan/99	6,436312
fev/99	6,363127
mar/99	6,092620
abr/99	5,974325
mai/99	5,972540
jun/99	5,972540
jul/99	5,912229
ago/99	5,819702
set/99	5,736521
out/99	5,653411
nov/99	5,548548
dez/99	5,411633
jan/00	5,345881
fev/00	5,291900
mar/00	5,281864
abr/00	5,272374
mai/00	5,265529
jun/00	5,230483
jul/00	5,182292
ago/00	5,067762
set/00	4,977173
out/00	4,943066
nov/00	4,924847
dez/00	4,905709
jan/01	4,868708
fev/01	4,844975
mar/01	4,828553
abr/01	4,790229
mai/01	4,736709
jun/01	4,715961
jul/01	4,648095
ago/01	4,573999
set/01	4,533192
out/01	4,516037
nov/01	4,451487
dez/01	4,417909
jan/02	4,409980
fev/02	4,401617
mar/02	4,393709
abr/02	4,388877
mai/02	4,358370
jun/02	4,310522
jul/02	4,236795
ago/02	4,151694
set/02	4,055975
out/02	3,951645
nov/02	3,792007
dez/02	3,582760
jan/03	3,488574
fev/03	3,414475
mar/03	3,361043
abr/03	3,306164
mai/03	3,292658
jun/03	3,314872
jul/03	3,338236
ago/03	3,344933
set/03	3,324317
out/03	3,289776
nov/03	3,275360
dez/03	3,259715
jan/04	3,240276
fev/04	3,214558
mar/04	3,202068
abr/04	3,183925
mai/04	3,170919
jun/04	3,158283
jul/04	3,142585
ago/04	3,119805
set/04	3,104280
out/04	3,099016
nov/04	3,093756
dez/04	3,080195
jan/05	3,053933
fev/05	3,036626
mar/05	3,023324
abr/05	3,001409
mai/05	2,974344
jun/05	2,953669
jul/05	2,956921
ago/05	2,956035
set/05	2,956035
out/05	2,951608
nov/05	2,934594
dez/05	2,918826
jan/06	2,907200
fev/06	2,896194
mar/06	2,889553
abr/06	2,881767
mai/06	2,878312
jun/06	2,874578
jul/06	2,876584
ago/06	2,873430
set/06	2,873999
out/06	2,869415
nov/06	2,857125
dez/06	2,845175
jan/07	2,827642
fev/07	2,813863
mar/07	2,802089
abr/07	2,789810
mai/07	2,782579
jun/07	2,775359
jul/07	2,766790
ago/07	2,757957
set/07	2,741782
out/07	2,734948
nov/07	2,726771
dez/07	2,715086
jan/08	2,689000
fev/08	2,670579
mar/08	2,657029
abr/08	2,643546
mai/08	2,626736
jun/08	2,601765
jul/08	2,578300
ago/08	2,563428
set/08	2,558053
out/08	2,554221
nov/08	2,541516
dez/08	2,531896
jan/09	2,524582
fev/09	2,508523
mar/09	2,500771
abr/09	2,495774
mai/09	2,482134
jun/09	2,467325
jul/09	2,457001
ago/09	2,451363
set/09	2,449402
out/09	2,445492
nov/09	2,439637
dez/09	2,430642
jan/10	2,424814
fev/10	2,403670
mar/10	2,386959
abr/10	2,370132
mai/10	2,352955
jun/10	2,342882
jul/10	2,345465
ago/10	2,347109
set/10	2,348756
out/10	2,336140
nov/10	2,314837
dez/10	2,291236
jan/11	2,277575
fev/11	2,256365
mar/11	2,244246
abr/11	2,229531
mai/11	2,213585
jun/11	2,201046
jul/11	2,196212
ago/11	2,196212
set/11	2,187023
out/11	2,177231
nov/11	2,170288
dez/11	2,157978
jan/12	2,147042
fev/12	2,136142
mar/12	2,127838
abr/12	2,124015
mai/12	2,110519
jun/12	2,098970
jul/12	2,093520
ago/12	2,084566
set/12	2,075222
out/12	2,062230
nov/12	2,047695
dez/12	2,036700
jan/13	2,021731
fev/13	2,003304
mar/13	1,992938
abr/13	1,981051
mai/13	1,969430
jun/13	1,962564
jul/13	1,957085
ago/13	1,959631
set/13	1,956501
out/13	1,951231
nov/13	1,939407
dez/13	1,928983
jan/14	1,915193
fev/14	1,903216
mar/14	1,891107
abr/14	1,875728
mai/14	1,861203
jun/14	1,850099
jul/14	1,845302
ago/14	1,842908
set/14	1,839594
out/14	1,830630
nov/14	1,823701
dez/14	1,814086
jan/15	1,802906
fev/15	1,776612
mar/15	1,756239
abr/15	1,730116
mai/15	1,717915
jun/15	1,701077
jul/15	1,688083
ago/15	1,678350
set/15	1,674156
out/15	1,665663
nov/15	1,652939
dez/15	1,634788
jan/16	1,620208
fev/16	1,596110
mar/16	1,581085
abr/16	1,574158
mai/16	1,564150
jun/16	1,548973
jul/16	1,541724
ago/16	1,531914
set/16	1,527187
out/16	1,525972
nov/16	1,523371
dez/16	1,522312
jan/17	1,520186
fev/17	1,513821
mar/17	1,510201
abr/17	1,505384
mai/17	1,504185
jun/17	1,498781
jul/17	1,503294
ago/17	1,500748
set/17	1,501191
out/17	1,501497
nov/17	1,495958
dez/17	1,493268
jan/18	1,489403
fev/18	1,485985
mar/18	1,483311
abr/18	1,482275
mai/18	1,479163
jun/18	1,472836
jul/18	1,452069
ago/18	1,448447
set/18	1,448447
out/18	1,444114
nov/18	1,438365
dez/18	1,441966
jan/19	1,439955
fev/19	1,434785
mar/19	1,427079
abr/19	1,416177
mai/19	1,407728
jun/19	1,405622
jul/19	1,405477
ago/19	1,404072
set/19	1,402388
out/19	1,403099
nov/19	1,402531
dez/19	1,395000
jan/20	1,378188
fev/20	1,375575
mar/20	1,373237
abr/20	1,370771
mai/20	1,373928
jun/20	1,377376
jul/20	1,373254
ago/20	1,367237
set/20	1,362331
out/20	1,350585
nov/20	1,338668
dez/20	1,326070
jan/21	1,306992
fev/21	1,303471
mar/21	1,292866
abr/21	1,281844
mai/21	1,276995
jun/21	1,264850
jul/21	1,257308
ago/21	1,244613
set/21	1,233757
out/21	1,219125
nov/21	1,205145
dez/21	1,195106
jan/22	1,186445
fev/22	1,178548
mar/22	1,166882
abr/22	1,147264
mai/22	1,135453
jun/22	1,130366
jul/22	1,123401
ago/22	1,130185
set/22	1,133696
out/22	1,137337
nov/22	1,132016
dez/22	1,127730
jan/23	1,120001
fev/23	1,114874
mar/23	1,106355
abr/23	1,099319
mai/23	1,093524
jun/23	1,089599
jul/23	1,090691
ago/23	1,091675
set/23	1,089494
out/23	1,088297
nov/23	1,086996
dez/23	1,085909
jan/24	1,079968
fev/24	1,073845
mar/24	1,065218
abr/24	1,063200
mai/24	1,059279
jun/24	1,054429
jul/24	1,051801
ago/24	1,049072
set/24	1,050543
out/24	1,045524
nov/24	1,039185
dez/24	1,035766
jan/25	1,030819
fev/25	1,030819
mar/25	1,015785
abr/25	1,010631
mai/25	1,005803
jun/25	1,002296
jul/25	0,999996
ago/25	0,997900
"""

def seed_db():
    with app.app_context():
        factors_to_add = parse_factors(factors_data_string)

        existing_factors = {f.month_year for f in CorrectionFactor.query.all()}

        new_factors = []
        for month_year, value in factors_to_add:
            # Check for duplicates like 'set/97'
            if month_year not in existing_factors:
                new_factors.append(CorrectionFactor(month_year=month_year, value=value))
                existing_factors.add(month_year) # Add to set to handle duplicates in source data

        if new_factors:
            db.session.bulk_save_objects(new_factors)
            db.session.commit()
            print(f"Added {len(new_factors)} new factors to the database.")
        else:
            print("All factors are already in the database.")

if __name__ == '__main__':
    seed_db()
